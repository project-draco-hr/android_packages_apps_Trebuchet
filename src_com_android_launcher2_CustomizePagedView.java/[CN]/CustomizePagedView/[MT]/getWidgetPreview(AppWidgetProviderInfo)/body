{
  PackageManager packageManager=mLauncher.getPackageManager();
  String packageName=info.provider.getPackageName();
  Drawable drawable=null;
  if (info.previewImage != 0) {
    drawable=packageManager.getDrawable(packageName,info.previewImage,null);
    if (drawable == null) {
      Log.w(TAG,"Can't load icon drawable 0x" + Integer.toHexString(info.icon) + " for provider: "+ info.provider);
    }
  }
  final int minDim=mWorkspaceWidgetLayout.estimateCellWidth(1);
  final int maxDim=mWorkspaceWidgetLayout.estimateCellWidth(3);
  if (drawable == null) {
    Resources resources=mLauncher.getResources();
    int width=(int)(Math.max(minDim,Math.min(maxDim,info.minWidth)) * sScaleFactor);
    int height=(int)(Math.max(minDim,Math.min(maxDim,info.minHeight)) * sScaleFactor);
    final Bitmap bitmap=Bitmap.createBitmap(width,height,Config.ARGB_8888);
    final Drawable background=resources.getDrawable(R.drawable.default_widget_preview);
    renderDrawableToBitmap(background,bitmap,0,0,width,height);
    try {
      Rect tmpRect=new Rect();
      Drawable icon=null;
      if (info.icon > 0) {
        icon=packageManager.getDrawable(packageName,info.icon,null);
      }
      if (icon == null) {
        icon=resources.getDrawable(R.drawable.ic_launcher_application);
      }
      background.getPadding(tmpRect);
      final int iconSize=minDim / 2;
      final int offset=iconSize / 4;
      final int offsetIconSize=offset + iconSize;
      renderDrawableToBitmap(icon,null,offset,offset,offsetIconSize,offsetIconSize);
    }
 catch (    Resources.NotFoundException e) {
    }
    drawable=new FastBitmapDrawable(bitmap);
  }
 else {
    final float imageWidth=drawable.getIntrinsicWidth();
    final float imageHeight=drawable.getIntrinsicHeight();
    final float aspect=(float)imageWidth / imageHeight;
    final int scaledWidth=(int)(Math.max(minDim,Math.min(maxDim,imageWidth)) * sScaleFactor);
    final int scaledHeight=(int)(Math.max(minDim,Math.min(maxDim,imageHeight)) * sScaleFactor);
    int width;
    int height;
    if (aspect >= 1.0f) {
      width=scaledWidth;
      height=(int)(((float)scaledWidth / imageWidth) * imageHeight);
    }
 else {
      height=scaledHeight;
      width=(int)(((float)scaledHeight / imageHeight) * imageWidth);
    }
    final Bitmap bitmap=Bitmap.createBitmap(width,height,Config.ARGB_8888);
    renderDrawableToBitmap(drawable,bitmap,0,0,width,height);
    drawable=new FastBitmapDrawable(bitmap);
  }
  drawable.setBounds(0,0,drawable.getIntrinsicWidth(),drawable.getIntrinsicHeight());
  return drawable;
}
