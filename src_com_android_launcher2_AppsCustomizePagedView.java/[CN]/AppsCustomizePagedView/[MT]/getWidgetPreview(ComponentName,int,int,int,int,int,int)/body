{
  String packageName=provider.getPackageName();
  if (maxWidth < 0)   maxWidth=Integer.MAX_VALUE;
  if (maxHeight < 0)   maxHeight=Integer.MAX_VALUE;
  Drawable drawable=null;
  if (previewImage != 0) {
    drawable=mPackageManager.getDrawable(packageName,previewImage,null);
    if (drawable == null) {
      Log.w(TAG,"Can't load widget preview drawable 0x" + Integer.toHexString(previewImage) + " for provider: "+ provider);
    }
  }
  int bitmapWidth;
  int bitmapHeight;
  Bitmap defaultPreview=null;
  boolean widgetPreviewExists=(drawable != null);
  if (widgetPreviewExists) {
    bitmapWidth=drawable.getIntrinsicWidth();
    bitmapHeight=drawable.getIntrinsicHeight();
  }
 else {
    if (cellHSpan < 1)     cellHSpan=1;
    if (cellVSpan < 1)     cellVSpan=1;
    BitmapDrawable previewDrawable=(BitmapDrawable)getResources().getDrawable(R.drawable.widget_preview_tile);
    final int previewDrawableWidth=previewDrawable.getIntrinsicWidth();
    final int previewDrawableHeight=previewDrawable.getIntrinsicHeight();
    bitmapWidth=previewDrawableWidth * cellHSpan;
    bitmapHeight=previewDrawableHeight * cellVSpan;
    defaultPreview=Bitmap.createBitmap(bitmapWidth,bitmapHeight,Config.ARGB_8888);
    final Canvas c=mCachedAppWidgetPreviewCanvas.get();
    c.setBitmap(defaultPreview);
    previewDrawable.setBounds(0,0,bitmapWidth,bitmapHeight);
    previewDrawable.setTileModeXY(Shader.TileMode.REPEAT,Shader.TileMode.REPEAT);
    previewDrawable.draw(c);
    c.setBitmap(null);
    int minOffset=(int)(mAppIconSize * sWidgetPreviewIconPaddingPercentage);
    int smallestSide=Math.min(bitmapWidth,bitmapHeight);
    float iconScale=Math.min((float)smallestSide / (mAppIconSize + 2 * minOffset),1f);
    try {
      Drawable icon=null;
      int hoffset=(int)((previewDrawableWidth - mAppIconSize * iconScale) / 2);
      int yoffset=(int)((previewDrawableHeight - mAppIconSize * iconScale) / 2);
      if (iconId > 0)       icon=mIconCache.getFullResIcon(packageName,iconId);
      if (icon != null) {
        renderDrawableToBitmap(icon,defaultPreview,hoffset,yoffset,(int)(mAppIconSize * iconScale),(int)(mAppIconSize * iconScale));
      }
    }
 catch (    Resources.NotFoundException e) {
    }
  }
  float scale=1f;
  if (bitmapWidth > maxWidth) {
    scale=maxWidth / (float)bitmapWidth;
  }
  if (scale != 1f) {
    bitmapWidth=(int)(scale * bitmapWidth);
    bitmapHeight=(int)(scale * bitmapHeight);
  }
  Bitmap preview=Bitmap.createBitmap(bitmapWidth,bitmapHeight,Config.ARGB_8888);
  if (widgetPreviewExists) {
    renderDrawableToBitmap(drawable,preview,0,0,bitmapWidth,bitmapHeight);
  }
 else {
    final Canvas c=mCachedAppWidgetPreviewCanvas.get();
    final Rect src=mCachedAppWidgetPreviewSrcRect.get();
    final Rect dest=mCachedAppWidgetPreviewDestRect.get();
    c.setBitmap(preview);
    src.set(0,0,defaultPreview.getWidth(),defaultPreview.getHeight());
    dest.set(0,0,preview.getWidth(),preview.getHeight());
    Paint p=mCachedAppWidgetPreviewPaint.get();
    if (p == null) {
      p=new Paint();
      p.setFilterBitmap(true);
      mCachedAppWidgetPreviewPaint.set(p);
    }
    c.drawBitmap(defaultPreview,src,dest,p);
    c.setBitmap(null);
  }
  return preview;
}
