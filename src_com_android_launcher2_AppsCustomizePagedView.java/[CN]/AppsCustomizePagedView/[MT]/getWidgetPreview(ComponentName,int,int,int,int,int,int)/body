{
  String packageName=provider.getPackageName();
  if (maxWidth < 0)   maxWidth=Integer.MAX_VALUE;
  if (maxHeight < 0)   maxHeight=Integer.MAX_VALUE;
  Drawable drawable=null;
  if (previewImage != 0) {
    drawable=mPackageManager.getDrawable(packageName,previewImage,null);
    if (drawable == null) {
      Log.w(LOG_TAG,"Can't load widget preview drawable 0x" + Integer.toHexString(previewImage) + " for provider: "+ provider);
    }
  }
  int bitmapWidth;
  int bitmapHeight;
  boolean widgetPreviewExists=(drawable != null);
  if (widgetPreviewExists) {
    bitmapWidth=drawable.getIntrinsicWidth();
    bitmapHeight=drawable.getIntrinsicHeight();
  }
 else {
    bitmapWidth=mWidgetSpacingLayout.estimateCellWidth(cellHSpan);
    bitmapHeight=mWidgetSpacingLayout.estimateCellHeight(cellVSpan);
    if (cellHSpan == cellVSpan) {
      int minOffset=(int)(mAppIconSize * sWidgetPreviewIconPaddingPercentage);
      if (cellHSpan <= 1) {
        bitmapWidth=bitmapHeight=mAppIconSize + 2 * minOffset;
      }
 else {
        bitmapWidth=bitmapHeight=mAppIconSize + 4 * minOffset;
      }
    }
  }
  float scale=1f;
  if (bitmapWidth > maxWidth) {
    scale=maxWidth / (float)bitmapWidth;
  }
  if (bitmapHeight * scale > maxHeight) {
    scale=maxHeight / (float)bitmapHeight;
  }
  if (scale != 1f) {
    bitmapWidth=(int)(scale * bitmapWidth);
    bitmapHeight=(int)(scale * bitmapHeight);
  }
  Bitmap preview=Bitmap.createBitmap(bitmapWidth,bitmapHeight,Config.ARGB_8888);
  if (widgetPreviewExists) {
    renderDrawableToBitmap(drawable,preview,0,0,bitmapWidth,bitmapHeight);
  }
 else {
    int minOffset=(int)(mAppIconSize * sWidgetPreviewIconPaddingPercentage);
    int smallestSide=Math.min(bitmapWidth,bitmapHeight);
    float iconScale=Math.min((float)smallestSide / (mAppIconSize + 2 * minOffset),1f);
    if (cellHSpan != 1 || cellVSpan != 1) {
      renderDrawableToBitmap(mDefaultWidgetBackground,preview,0,0,bitmapWidth,bitmapHeight);
    }
    try {
      Drawable icon=null;
      int hoffset=(int)(bitmapWidth / 2 - mAppIconSize * iconScale / 2);
      int yoffset=(int)(bitmapHeight / 2 - mAppIconSize * iconScale / 2);
      if (iconId > 0)       icon=mIconCache.getFullResIcon(packageName,iconId);
      Resources resources=mLauncher.getResources();
      if (icon == null)       icon=resources.getDrawable(R.drawable.ic_launcher_application);
      renderDrawableToBitmap(icon,preview,hoffset,yoffset,(int)(mAppIconSize * iconScale),(int)(mAppIconSize * iconScale));
    }
 catch (    Resources.NotFoundException e) {
    }
  }
  return preview;
}
