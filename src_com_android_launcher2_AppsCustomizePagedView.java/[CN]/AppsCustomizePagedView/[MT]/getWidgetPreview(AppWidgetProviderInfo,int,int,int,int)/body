{
  Bitmap cachedBitmap=mWidgetPreviewCache.get(info);
  if (cachedBitmap != null) {
    return new FastBitmapDrawable(cachedBitmap);
  }
  cellHSpan=Math.max(mMinWidgetSpan,Math.min(mMaxWidgetSpan,cellHSpan));
  cellVSpan=Math.max(mMinWidgetSpan,Math.min(mMaxWidgetSpan,cellVSpan));
  int expectedWidth=mWidgetSpacingLayout.estimateCellWidth(cellHSpan);
  int expectedHeight=mWidgetSpacingLayout.estimateCellHeight(cellVSpan);
  float widgetPreviewScale=(float)cellWidth / expectedWidth;
  expectedWidth=(int)(widgetPreviewScale * expectedWidth);
  expectedHeight=(int)(widgetPreviewScale * expectedHeight);
  String packageName=info.provider.getPackageName();
  Drawable drawable=null;
  FastBitmapDrawable newDrawable=null;
  if (info.previewImage != 0) {
    drawable=mPackageManager.getDrawable(packageName,info.previewImage,null);
    if (drawable == null) {
      Log.w(LOG_TAG,"Can't load icon drawable 0x" + Integer.toHexString(info.icon) + " for provider: "+ info.provider);
    }
 else {
      int imageWidth=drawable.getIntrinsicWidth();
      int imageHeight=drawable.getIntrinsicHeight();
      float aspect=(float)imageWidth / imageHeight;
      int newWidth=imageWidth;
      int newHeight=imageHeight;
      if (aspect > 1f) {
        newWidth=expectedWidth;
        newHeight=(int)(imageHeight * ((float)expectedWidth / imageWidth));
      }
 else {
        newHeight=expectedHeight;
        newWidth=(int)(imageWidth * ((float)expectedHeight / imageHeight));
      }
      Bitmap preview=Bitmap.createBitmap(newWidth,newHeight,Config.ARGB_8888);
      renderDrawableToBitmap(drawable,preview,0,0,newWidth,newHeight,1f,1f);
      newDrawable=new FastBitmapDrawable(preview);
      newDrawable.setBounds(0,0,newWidth,newHeight);
      mWidgetPreviewCache.put(info,preview);
    }
  }
  if (drawable == null) {
    Resources resources=mLauncher.getResources();
    int iconSize=resources.getDimensionPixelSize(R.dimen.app_icon_size);
    if (info.minWidth >= info.minHeight) {
      expectedWidth=cellWidth;
      expectedHeight=mWidgetPreviewIconPaddedDimension;
    }
 else {
      expectedWidth=mWidgetPreviewIconPaddedDimension;
      expectedHeight=cellWidth;
    }
    Bitmap preview=Bitmap.createBitmap(expectedWidth,expectedHeight,Config.ARGB_8888);
    renderDrawableToBitmap(mDefaultWidgetBackground,preview,0,0,expectedWidth,expectedHeight,1f,1f);
    try {
      Drawable icon=null;
      if (info.icon > 0)       icon=mPackageManager.getDrawable(packageName,info.icon,null);
      if (icon == null)       icon=resources.getDrawable(R.drawable.ic_launcher_application);
      int offset=(int)(iconSize * sWidgetPreviewIconPaddingPercentage);
      renderDrawableToBitmap(icon,preview,offset,offset,iconSize,iconSize,1f,1f);
    }
 catch (    Resources.NotFoundException e) {
    }
    newDrawable=new FastBitmapDrawable(preview);
    newDrawable.setBounds(0,0,expectedWidth,expectedHeight);
    mWidgetPreviewCache.put(info,preview);
  }
  return newDrawable;
}
