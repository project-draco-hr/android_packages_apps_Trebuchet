{
  cellHSpan=Math.max(mMinWidgetSpan,Math.min(mMaxWidgetSpan,cellHSpan));
  cellVSpan=Math.max(mMinWidgetSpan,Math.min(mMaxWidgetSpan,cellVSpan));
  int expectedWidth=mWidgetSpacingLayout.estimateCellWidth(cellHSpan);
  int expectedHeight=mWidgetSpacingLayout.estimateCellHeight(cellVSpan);
  float widgetPreviewScale=(float)cellWidth / expectedWidth;
  expectedWidth=(int)(widgetPreviewScale * expectedWidth);
  expectedHeight=(int)(widgetPreviewScale * expectedHeight);
  String packageName=info.provider.getPackageName();
  Drawable drawable=null;
  Bitmap preview=null;
  if (info.previewImage != 0) {
    drawable=mPackageManager.getDrawable(packageName,info.previewImage,null);
    if (drawable == null) {
      Log.w(LOG_TAG,"Can't load icon drawable 0x" + Integer.toHexString(info.icon) + " for provider: "+ info.provider);
    }
 else {
      int imageWidth=drawable.getIntrinsicWidth();
      int imageHeight=drawable.getIntrinsicHeight();
      float aspect=(float)imageWidth / imageHeight;
      int newWidth=imageWidth;
      int newHeight=imageHeight;
      if (aspect > 1f) {
        newWidth=expectedWidth;
        newHeight=(int)(imageHeight * ((float)expectedWidth / imageWidth));
      }
 else {
        newHeight=expectedHeight;
        newWidth=(int)(imageWidth * ((float)expectedHeight / imageHeight));
      }
      preview=Bitmap.createBitmap(newWidth,newHeight,Config.ARGB_8888);
      renderDrawableToBitmap(drawable,preview,0,0,newWidth,newHeight,1f,1f);
    }
  }
  if (drawable == null) {
    Resources resources=mLauncher.getResources();
    int bitmapWidth;
    int bitmapHeight;
    if (cellHSpan == cellVSpan) {
      bitmapWidth=bitmapHeight=cellWidth;
      expectedWidth=expectedHeight=mWidgetPreviewIconPaddedDimension;
    }
 else     if (cellHSpan >= cellVSpan) {
      bitmapWidth=expectedWidth=cellWidth;
      bitmapHeight=expectedHeight=mWidgetPreviewIconPaddedDimension;
    }
 else {
      bitmapWidth=expectedWidth=mWidgetPreviewIconPaddedDimension;
      bitmapHeight=expectedHeight=cellWidth;
    }
    preview=Bitmap.createBitmap(bitmapWidth,bitmapHeight,Config.ARGB_8888);
    renderDrawableToBitmap(mDefaultWidgetBackground,preview,0,0,expectedWidth,expectedHeight,1f,1f);
    try {
      Drawable icon=null;
      if (info.icon > 0)       icon=mPackageManager.getDrawable(packageName,info.icon,null);
      if (icon == null)       icon=resources.getDrawable(R.drawable.ic_launcher_application);
      int offset=(int)(mAppIconSize * sWidgetPreviewIconPaddingPercentage);
      renderDrawableToBitmap(icon,preview,offset,offset,mAppIconSize,mAppIconSize,1f,1f);
    }
 catch (    Resources.NotFoundException e) {
    }
  }
  return preview;
}
