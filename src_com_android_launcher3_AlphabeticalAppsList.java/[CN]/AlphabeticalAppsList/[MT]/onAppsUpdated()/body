{
  Collections.sort(mApps,mAppNameComparator.getComparator());
  mFilteredApps.clear();
  mSections.clear();
  mSectionedFilteredApps.clear();
  mFastScrollerSections.clear();
  SectionInfo lastSectionInfo=null;
  String lastSectionName=null;
  FastScrollSectionInfo lastFastScrollerSectionInfo=null;
  int position=0;
  int appIndex=0;
  List<AppInfo> allApps=new ArrayList<>();
  int numPredictedApps=0;
  if (mPredictedApps != null && !mPredictedApps.isEmpty() && !hasFilter()) {
    for (    ComponentName cn : mPredictedApps) {
      for (      AppInfo info : mApps) {
        if (cn.equals(info.componentName)) {
          allApps.add(info);
          numPredictedApps++;
          break;
        }
      }
      if (numPredictedApps == mNumAppsPerRow) {
        break;
      }
    }
  }
  allApps.addAll(mApps);
  int numApps=allApps.size();
  for (int i=0; i < numApps; i++) {
    boolean isPredictedApp=i < numPredictedApps;
    AppInfo info=allApps.get(i);
    String sectionName=isPredictedApp ? "" : mIndexer.computeSectionName(info.title);
    if (mFilter != null && !mFilter.retainApp(info,sectionName)) {
      continue;
    }
    if (lastSectionInfo == null || (!isPredictedApp && !sectionName.equals(lastSectionName))) {
      lastSectionName=sectionName;
      lastSectionInfo=new SectionInfo();
      lastFastScrollerSectionInfo=new FastScrollSectionInfo(sectionName,(float)appIndex / numApps);
      mSections.add(lastSectionInfo);
      mFastScrollerSections.add(lastFastScrollerSectionInfo);
      if (!AppsContainerView.GRID_HIDE_SECTION_HEADERS && !hasFilter()) {
        AdapterItem sectionItem=AdapterItem.asSectionBreak(position++,lastSectionInfo);
        mSectionedFilteredApps.add(sectionItem);
      }
    }
    AdapterItem appItem=AdapterItem.asApp(position++,lastSectionInfo,sectionName,lastSectionInfo.numApps++,info,appIndex++,isPredictedApp);
    if (lastSectionInfo.firstAppItem == null) {
      lastSectionInfo.firstAppItem=appItem;
      lastFastScrollerSectionInfo.appItem=appItem;
    }
    mSectionedFilteredApps.add(appItem);
    mFilteredApps.add(info);
  }
  if (AppsContainerView.GRID_MERGE_SECTIONS && !hasFilter()) {
    int minNumAppsPerRow=(int)Math.ceil(mNumAppsPerRow / 2f);
    int sectionAppCount=0;
    for (int i=0; i < mSections.size(); i++) {
      SectionInfo section=mSections.get(i);
      sectionAppCount=section.numApps;
      int mergeCount=1;
      while (0 < (sectionAppCount % mNumAppsPerRow) && (sectionAppCount % mNumAppsPerRow) < minNumAppsPerRow && (sectionAppCount / mNumAppsPerRow) < MAX_ROWS_IN_MERGED_SECTION && (i + 1) < mSections.size()) {
        SectionInfo nextSection=mSections.remove(i + 1);
        mSectionedFilteredApps.remove(nextSection.sectionBreakItem);
        int pos=mSectionedFilteredApps.indexOf(section.firstAppItem);
        int nextPos=pos + section.numApps;
        for (int j=nextPos; j < (nextPos + nextSection.numApps); j++) {
          AdapterItem item=mSectionedFilteredApps.get(j);
          item.sectionInfo=section;
          item.sectionAppIndex+=section.numApps;
        }
        pos=mSectionedFilteredApps.indexOf(nextSection.firstAppItem);
        for (int j=pos; j < mSectionedFilteredApps.size(); j++) {
          AdapterItem item=mSectionedFilteredApps.get(j);
          item.position--;
        }
        section.numApps+=nextSection.numApps;
        sectionAppCount+=nextSection.numApps;
        mergeCount++;
        if (mergeCount >= mMaxAllowableMerges) {
          break;
        }
      }
    }
  }
}
