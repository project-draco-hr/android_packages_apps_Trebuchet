{
  String name=getObjectName(o);
  boolean packageValid=true;
synchronized (sInvalidPackages) {
    packageValid=!sInvalidPackages.contains(getObjectPackage(o));
  }
  if (!packageValid) {
    return null;
  }
  if (packageValid) {
synchronized (sLoadedPreviews) {
      if (sLoadedPreviews.containsKey(name) && sLoadedPreviews.get(name).get() != null) {
        return sLoadedPreviews.get(name).get();
      }
    }
  }
  Bitmap unusedBitmap=null;
synchronized (sUnusedBitmaps) {
    while ((unusedBitmap == null || !unusedBitmap.isMutable()) && sUnusedBitmaps.size() > 0) {
      unusedBitmap=sUnusedBitmaps.remove(0).get();
    }
    if (unusedBitmap != null) {
      final Canvas c=mCachedAppWidgetPreviewCanvas.get();
      c.setBitmap(unusedBitmap);
      c.drawColor(0,PorterDuff.Mode.CLEAR);
      c.setBitmap(null);
    }
  }
  if (unusedBitmap == null) {
    unusedBitmap=Bitmap.createBitmap(mPreviewBitmapMaxWidth,mPreviewBitmapMaxHeight,Bitmap.Config.ARGB_8888);
  }
  Bitmap preview=null;
  if (packageValid) {
    preview=readFromDb(name,unusedBitmap);
  }
  if (preview != null) {
synchronized (sLoadedPreviews) {
      sLoadedPreviews.put(name,new WeakReference<Bitmap>(preview));
    }
    return preview;
  }
 else {
    final Bitmap generatedPreview=generatePreview(o,unusedBitmap);
    preview=generatedPreview;
    if (preview != unusedBitmap) {
      throw new RuntimeException("generatePreview is not recycling the bitmap " + o);
    }
synchronized (sLoadedPreviews) {
      sLoadedPreviews.put(name,new WeakReference<Bitmap>(preview));
    }
    new AsyncTask<Void,Void,Void>(){
      public Void doInBackground(      Void... args){
        writeToDb(o,generatedPreview);
        return null;
      }
    }
.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR,(Void)null);
    return preview;
  }
}
