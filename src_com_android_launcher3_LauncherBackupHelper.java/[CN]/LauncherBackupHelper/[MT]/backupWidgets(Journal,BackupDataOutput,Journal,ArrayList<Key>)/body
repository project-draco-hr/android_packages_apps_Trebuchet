{
  final LauncherAppState appState=LauncherAppState.getInstanceNoCreate();
  if (appState == null || !initializeIconCache()) {
    Log.w(TAG,"Failed to get icon cache during restore");
    return;
  }
  final ContentResolver cr=mContext.getContentResolver();
  final WidgetPreviewLoader previewLoader=new WidgetPreviewLoader(mContext);
  final PagedViewCellLayout widgetSpacingLayout=new PagedViewCellLayout(mContext);
  final int dpi=mContext.getResources().getDisplayMetrics().densityDpi;
  final DeviceProfile profile=appState.getDynamicGrid().getDeviceProfile();
  if (DEBUG)   Log.d(TAG,"cellWidthPx: " + profile.cellWidthPx);
  Set<String> savedIds=getSavedIdsByType(Key.WIDGET,in);
  if (DEBUG)   Log.d(TAG,"widgets savedIds.size()=" + savedIds.size());
  int startRows=out.rows;
  if (DEBUG)   Log.d(TAG,"starting here: " + startRows);
  String where=Favorites.ITEM_TYPE + "=" + Favorites.ITEM_TYPE_APPWIDGET+ " AND "+ getUserSelectionArg();
  Cursor cursor=cr.query(Favorites.CONTENT_URI,FAVORITE_PROJECTION,where,null,null);
  Set<String> currentIds=new HashSet<String>(cursor.getCount());
  try {
    cursor.moveToPosition(-1);
    while (cursor.moveToNext()) {
      final long id=cursor.getLong(ID_INDEX);
      final String providerName=cursor.getString(APPWIDGET_PROVIDER_INDEX);
      final int spanX=cursor.getInt(SPANX_INDEX);
      final int spanY=cursor.getInt(SPANY_INDEX);
      final ComponentName provider=ComponentName.unflattenFromString(providerName);
      Key key=null;
      String backupKey=null;
      if (provider != null) {
        key=getKey(Key.WIDGET,providerName);
        backupKey=keyToBackupKey(key);
        currentIds.add(backupKey);
      }
 else {
        Log.w(TAG,"empty intent on appwidget: " + id);
      }
      if (savedIds.contains(backupKey)) {
        if (VERBOSE)         Log.v(TAG,"already saved widget " + backupKey);
        keys.add(key);
      }
 else       if (backupKey != null) {
        if (DEBUG)         Log.d(TAG,"I can count this high: " + out.rows);
        if ((out.rows - startRows) < MAX_WIDGETS_PER_PASS) {
          if (VERBOSE)           Log.v(TAG,"saving widget " + backupKey);
          previewLoader.setPreviewSize(spanX * profile.cellWidthPx,spanY * profile.cellHeightPx,widgetSpacingLayout);
          byte[] blob=packWidget(dpi,previewLoader,mIconCache,provider);
          keys.add(key);
          writeRowToBackup(key,blob,out,data);
        }
 else {
          if (VERBOSE)           Log.d(TAG,"deferring widget backup " + backupKey);
          dataChanged();
        }
      }
    }
  }
  finally {
    cursor.close();
  }
  if (DEBUG)   Log.d(TAG,"widget currentIds.size()=" + currentIds.size());
  savedIds.removeAll(currentIds);
  out.rows+=removeDeletedKeysFromBackup(savedIds,data);
}
