{
  final AppWidgetManager appWidgetManager=AppWidgetManager.getInstance(mContext);
  final int[] bindSources=new int[]{Favorites.ITEM_TYPE_WIDGET_CLOCK,Favorites.ITEM_TYPE_WIDGET_PHOTO_FRAME,Favorites.ITEM_TYPE_WIDGET_SEARCH};
  final String selectWhere=buildOrWhereString(Favorites.ITEM_TYPE,bindSources);
  Cursor c=null;
  db.beginTransaction();
  try {
    c=db.query(TABLE_FAVORITES,new String[]{Favorites._ID,Favorites.ITEM_TYPE},selectWhere,null,null,null,null);
    if (LOGD)     Log.d(TAG,"found upgrade cursor count=" + c.getCount());
    final ContentValues values=new ContentValues();
    while (c != null && c.moveToNext()) {
      long favoriteId=c.getLong(0);
      int favoriteType=c.getInt(1);
      try {
        int appWidgetId=mAppWidgetHost.allocateAppWidgetId();
        if (LOGD) {
          Log.d(TAG,"allocated appWidgetId=" + appWidgetId + " for favoriteId="+ favoriteId);
        }
        values.clear();
        values.put(Favorites.ITEM_TYPE,Favorites.ITEM_TYPE_APPWIDGET);
        values.put(Favorites.APPWIDGET_ID,appWidgetId);
        if (favoriteType == Favorites.ITEM_TYPE_WIDGET_SEARCH) {
          values.put(LauncherSettings.Favorites.SPANX,4);
          values.put(LauncherSettings.Favorites.SPANY,1);
        }
 else {
          values.put(LauncherSettings.Favorites.SPANX,2);
          values.put(LauncherSettings.Favorites.SPANY,2);
        }
        String updateWhere=Favorites._ID + "=" + favoriteId;
        db.update(TABLE_FAVORITES,values,updateWhere,null);
        if (favoriteType == Favorites.ITEM_TYPE_WIDGET_CLOCK) {
          appWidgetManager.bindAppWidgetIdIfAllowed(appWidgetId,new ComponentName("com.android.alarmclock","com.android.alarmclock.AnalogAppWidgetProvider"));
        }
 else         if (favoriteType == Favorites.ITEM_TYPE_WIDGET_PHOTO_FRAME) {
          appWidgetManager.bindAppWidgetIdIfAllowed(appWidgetId,new ComponentName("com.android.camera","com.android.camera.PhotoAppWidgetProvider"));
        }
 else         if (favoriteType == Favorites.ITEM_TYPE_WIDGET_SEARCH) {
          appWidgetManager.bindAppWidgetIdIfAllowed(appWidgetId,getSearchWidgetProvider());
        }
      }
 catch (      RuntimeException ex) {
        Log.e(TAG,"Problem allocating appWidgetId",ex);
      }
    }
    db.setTransactionSuccessful();
  }
 catch (  SQLException ex) {
    Log.w(TAG,"Problem while allocating appWidgetIds for existing widgets",ex);
  }
 finally {
    db.endTransaction();
    if (c != null) {
      c.close();
    }
  }
}
