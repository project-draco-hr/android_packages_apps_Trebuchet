{
  ContentValues values=new ContentValues();
  if (LOGD)   Log.v(TAG,String.format("Loading favorites from resid=0x%08x",workspaceResourceId));
  int count=0;
  try {
    XmlResourceParser parser=res.getXml(workspaceResourceId);
    beginDocument(parser,TAG_FAVORITES);
    final int depth=parser.getDepth();
    int type;
    while (((type=parser.next()) != XmlPullParser.END_TAG || parser.getDepth() > depth) && type != XmlPullParser.END_DOCUMENT) {
      if (type != XmlPullParser.START_TAG) {
        continue;
      }
      boolean added=false;
      final String name=parser.getName();
      if (TAG_INCLUDE.equals(name)) {
        final int resId=getAttributeResourceValue(parser,ATTR_WORKSPACE,0);
        if (LOGD)         Log.v(TAG,String.format(("%" + (2 * (depth + 1)) + "s<include workspace=%08x>"),"",resId));
        if (resId != 0 && resId != workspaceResourceId) {
          count+=loadFavoritesRecursive(db,res,resId,screenIds);
          added=false;
        }
 else {
          Log.w(TAG,String.format("Skipping <include workspace=0x%08x>",resId));
        }
        if (LOGD)         Log.v(TAG,String.format(("%" + (2 * (depth + 1)) + "s</include>"),""));
        continue;
      }
      long container=LauncherSettings.Favorites.CONTAINER_DESKTOP;
      String strContainer=getAttributeValue(parser,ATTR_CONTAINER);
      if (strContainer != null) {
        container=Long.valueOf(strContainer);
      }
      String screen=getAttributeValue(parser,ATTR_SCREEN);
      String x=getAttributeValue(parser,ATTR_X);
      String y=getAttributeValue(parser,ATTR_Y);
      values.clear();
      values.put(LauncherSettings.Favorites.CONTAINER,container);
      values.put(LauncherSettings.Favorites.SCREEN,screen);
      values.put(LauncherSettings.Favorites.CELLX,x);
      values.put(LauncherSettings.Favorites.CELLY,y);
      if (LOGD) {
        final String title=getAttributeValue(parser,ATTR_TITLE);
        final String pkg=getAttributeValue(parser,ATTR_PACKAGE_NAME);
        final String something=title != null ? title : pkg;
        Log.v(TAG,String.format(("%" + (2 * (depth + 1)) + "s<%s%s c=%d s=%s x=%s y=%s>"),"",name,(something == null ? "" : (" \"" + something + "\"")),container,screen,x,y));
      }
      if (TAG_FAVORITE.equals(name)) {
        long id=addAppShortcut(db,values,parser);
        added=id >= 0;
      }
 else       if (TAG_APPWIDGET.equals(name)) {
        added=addAppWidget(parser,type,db,values);
      }
 else       if (TAG_SHORTCUT.equals(name)) {
        long id=addUriShortcut(db,values,res,parser);
        added=id >= 0;
      }
 else       if (TAG_RESOLVE.equals(name)) {
        added=false;
        final int groupDepth=parser.getDepth();
        while ((type=parser.next()) != XmlPullParser.END_TAG || parser.getDepth() > groupDepth) {
          if (type != XmlPullParser.START_TAG) {
            continue;
          }
          final String fallback_item_name=parser.getName();
          if (!added) {
            if (TAG_FAVORITE.equals(fallback_item_name)) {
              final long id=addAppShortcut(db,values,parser);
              added=id >= 0;
            }
 else {
              Log.e(TAG,"Fallback groups can contain only favorites, found " + fallback_item_name);
            }
          }
        }
      }
 else       if (TAG_FOLDER.equals(name)) {
        added=loadFolder(db,values,mContext.getResources(),parser);
      }
 else       if (TAG_PARTNER_FOLDER.equals(name)) {
        final Partner partner=Partner.get(mPackageManager);
        if (partner != null) {
          final Resources partnerRes=partner.getResources();
          final int resId=partnerRes.getIdentifier(Partner.RESOURCE_FOLDER,"xml",partner.getPackageName());
          if (resId != 0) {
            final XmlResourceParser partnerParser=partnerRes.getXml(resId);
            beginDocument(partnerParser,TAG_FOLDER);
            added=loadFolder(db,values,partnerRes,partnerParser);
          }
        }
      }
      if (added) {
        long screenId=Long.parseLong(screen);
        if (!screenIds.contains(screenId) && container == LauncherSettings.Favorites.CONTAINER_DESKTOP) {
          screenIds.add(screenId);
        }
        count++;
      }
    }
  }
 catch (  XmlPullParserException e) {
    Log.w(TAG,"Got exception parsing favorites.",e);
  }
catch (  IOException e) {
    Log.w(TAG,"Got exception parsing favorites.",e);
  }
catch (  RuntimeException e) {
    Log.w(TAG,"Got exception parsing favorites.",e);
  }
  return count;
}
