{
  final ContentResolver cr=getContentResolver();
  final PagedViewCellLayout widgetSpacingLayout=new PagedViewCellLayout(this);
  final WidgetPreviewLoader previewLoader=new WidgetPreviewLoader(this);
  final LauncherAppState appState=LauncherAppState.getInstance();
  final IconCache iconCache=appState.getIconCache();
  final int dpi=getResources().getDisplayMetrics().densityDpi;
  final DeviceProfile profile=appState.getDynamicGrid().getDeviceProfile();
  if (DEBUG)   Log.d(TAG,"cellWidthPx: " + profile.cellWidthPx);
  Set<String> savedIds=getSavedIdsByType(Key.WIDGET,in);
  if (DEBUG)   Log.d(TAG,"widgets savedIds.size()=" + savedIds.size());
  int startRows=out.rows;
  if (DEBUG)   Log.d(TAG,"starting here: " + startRows);
  String where=Favorites.ITEM_TYPE + "=" + Favorites.ITEM_TYPE_APPWIDGET;
  Cursor cursor=cr.query(Favorites.CONTENT_URI,FAVORITE_PROJECTION,where,null,null);
  Set<String> currentIds=new HashSet<String>(cursor.getCount());
  try {
    cursor.moveToPosition(-1);
    while (cursor.moveToNext()) {
      final long id=cursor.getLong(ID_INDEX);
      final String providerName=cursor.getString(APPWIDGET_PROVIDER_INDEX);
      final int spanX=cursor.getInt(SPANX_INDEX);
      final int spanY=cursor.getInt(SPANY_INDEX);
      final ComponentName provider=ComponentName.unflattenFromString(providerName);
      Key key=null;
      String backupKey=null;
      if (provider != null) {
        key=getKey(Key.WIDGET,providerName);
        backupKey=keyToBackupKey(key);
        currentIds.add(backupKey);
      }
 else {
        Log.w(TAG,"empty intent on appwidget: " + id);
      }
      if (savedIds.contains(backupKey)) {
        if (DEBUG)         Log.d(TAG,"already saved widget " + backupKey);
        keys.add(key);
      }
 else       if (backupKey != null) {
        if (DEBUG)         Log.d(TAG,"I can count this high: " + out.rows);
        if ((out.rows - startRows) < MAX_WIDGETS_PER_PASS) {
          if (DEBUG)           Log.d(TAG,"saving widget " + backupKey);
          previewLoader.setPreviewSize(spanX * profile.cellWidthPx,spanY * profile.cellHeightPx,widgetSpacingLayout);
          byte[] blob=packWidget(dpi,previewLoader,iconCache,provider);
          writeRowToBackup(key,blob,out,data);
        }
 else {
          if (DEBUG)           Log.d(TAG,"scheduling another run for widget " + backupKey);
          dataChanged(this);
        }
      }
    }
  }
  finally {
    cursor.close();
  }
  if (DEBUG)   Log.d(TAG,"widget currentIds.size()=" + currentIds.size());
  savedIds.removeAll(currentIds);
  out.rows+=removeDeletedKeysFromBackup(savedIds,data);
}
