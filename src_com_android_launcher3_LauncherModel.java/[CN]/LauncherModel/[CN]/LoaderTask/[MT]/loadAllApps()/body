{
  final long loadTime=DEBUG_LOADERS ? SystemClock.uptimeMillis() : 0;
  final Callbacks oldCallbacks=mCallbacks.get();
  if (oldCallbacks == null) {
    Log.w(TAG,"LoaderTask running with no launcher (loadAllApps)");
    return;
  }
  final Intent mainIntent=new Intent(Intent.ACTION_MAIN,null);
  mainIntent.addCategory(Intent.CATEGORY_LAUNCHER);
  final List<UserHandleCompat> profiles=mUserManager.getUserProfiles();
  mBgAllAppsList.clear();
  SharedPreferences prefs=mContext.getSharedPreferences(LauncherAppState.getSharedPreferencesKey(),Context.MODE_PRIVATE);
  for (  UserHandleCompat user : profiles) {
    final long qiaTime=DEBUG_LOADERS ? SystemClock.uptimeMillis() : 0;
    List<LauncherActivityInfoCompat> apps=mLauncherApps.getActivityList(null,user);
    if (DEBUG_LOADERS) {
      Log.d(TAG,"getActivityList took " + (SystemClock.uptimeMillis() - qiaTime) + "ms for user "+ user);
      Log.d(TAG,"getActivityList got " + apps.size() + " apps for user "+ user);
    }
    if (apps == null || apps.isEmpty()) {
      return;
    }
    HashSet<String> updatedPackages=mIconCache.updateDBIcons(user,apps);
    if (!updatedPackages.isEmpty()) {
      final ArrayList<ShortcutInfo> updates=new ArrayList<ShortcutInfo>();
synchronized (sBgLock) {
        for (        ItemInfo info : sBgItemsIdMap.values()) {
          if (info instanceof ShortcutInfo && user.equals(info.user) && info.itemType == LauncherSettings.Favorites.ITEM_TYPE_APPLICATION) {
            ShortcutInfo si=(ShortcutInfo)info;
            ComponentName cn=si.getTargetComponent();
            if (cn != null && updatedPackages.contains(cn.getPackageName())) {
              si.updateIcon(mIconCache);
              updates.add(si);
            }
          }
        }
      }
      if (!updates.isEmpty()) {
        final UserHandleCompat userFinal=user;
        mHandler.post(new Runnable(){
          public void run(){
            Callbacks cb=getCallback();
            if (cb != null) {
              cb.bindShortcutsChanged(updates,new ArrayList<ShortcutInfo>(),userFinal);
            }
          }
        }
);
      }
    }
    for (int i=0; i < apps.size(); i++) {
      LauncherActivityInfoCompat app=apps.get(i);
      mBgAllAppsList.add(new AppInfo(mContext,app,user,mIconCache));
    }
    if (ADD_MANAGED_PROFILE_SHORTCUTS && !user.equals(UserHandleCompat.myUserHandle())) {
      String shortcutsSetKey=INSTALLED_SHORTCUTS_SET_PREFIX + mUserManager.getSerialNumberForUser(user);
      Set<String> packagesAdded=prefs.getStringSet(shortcutsSetKey,Collections.EMPTY_SET);
      HashSet<String> newPackageSet=new HashSet<String>();
      for (      LauncherActivityInfoCompat info : apps) {
        String packageName=info.getComponentName().getPackageName();
        if (!packagesAdded.contains(packageName) && !newPackageSet.contains(packageName)) {
          InstallShortcutReceiver.queueInstallShortcut(info,mContext);
        }
        newPackageSet.add(packageName);
      }
      prefs.edit().putStringSet(shortcutsSetKey,newPackageSet).commit();
    }
  }
  final ArrayList<AppInfo> added=mBgAllAppsList.added;
  mBgAllAppsList.added=new ArrayList<AppInfo>();
  mHandler.post(new Runnable(){
    public void run(){
      final long bindTime=SystemClock.uptimeMillis();
      final Callbacks callbacks=tryGetCallbacks(oldCallbacks);
      if (callbacks != null) {
        callbacks.bindAllApplications(added);
        if (DEBUG_LOADERS) {
          Log.d(TAG,"bound " + added.size() + " apps in "+ (SystemClock.uptimeMillis() - bindTime)+ "ms");
        }
      }
 else {
        Log.i(TAG,"not binding apps: no Launcher activity");
      }
    }
  }
);
  if (DEBUG_LOADERS) {
    Log.d(TAG,"Icons processed in " + (SystemClock.uptimeMillis() - loadTime) + "ms");
  }
}
