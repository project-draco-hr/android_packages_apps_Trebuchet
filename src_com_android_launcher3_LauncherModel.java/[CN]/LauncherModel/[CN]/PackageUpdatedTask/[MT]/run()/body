{
  final Context context=mApp.getContext();
  final String[] packages=mPackages;
  final int N=packages.length;
switch (mOp) {
case OP_ADD:
    for (int i=0; i < N; i++) {
      if (DEBUG_LOADERS)       Log.d(TAG,"mAllAppsList.addPackage " + packages[i]);
      mIconCache.remove(packages[i],mUser);
      mBgAllAppsList.addPackage(context,packages[i],mUser);
    }
  break;
case OP_UPDATE:
for (int i=0; i < N; i++) {
  if (DEBUG_LOADERS)   Log.d(TAG,"mAllAppsList.updatePackage " + packages[i]);
  mBgAllAppsList.updatePackage(context,packages[i],mUser);
  WidgetPreviewLoader.removePackageFromDb(mApp.getWidgetPreviewCacheDb(),packages[i]);
}
break;
case OP_REMOVE:
case OP_UNAVAILABLE:
boolean clearCache=mOp == OP_REMOVE;
for (int i=0; i < N; i++) {
if (DEBUG_LOADERS) Log.d(TAG,"mAllAppsList.removePackage " + packages[i]);
mBgAllAppsList.removePackage(packages[i],mUser,clearCache);
WidgetPreviewLoader.removePackageFromDb(mApp.getWidgetPreviewCacheDb(),packages[i]);
}
break;
}
ArrayList<AppInfo> added=null;
ArrayList<AppInfo> modified=null;
final ArrayList<AppInfo> removedApps=new ArrayList<AppInfo>();
if (mBgAllAppsList.added.size() > 0) {
added=new ArrayList<AppInfo>(mBgAllAppsList.added);
mBgAllAppsList.added.clear();
}
if (mBgAllAppsList.modified.size() > 0) {
modified=new ArrayList<AppInfo>(mBgAllAppsList.modified);
mBgAllAppsList.modified.clear();
}
if (mBgAllAppsList.removed.size() > 0) {
removedApps.addAll(mBgAllAppsList.removed);
mBgAllAppsList.removed.clear();
}
final Callbacks callbacks=mCallbacks != null ? mCallbacks.get() : null;
if (callbacks == null) {
Log.w(TAG,"Nobody to tell about the new app.  Launcher is probably loading.");
return;
}
if (added != null) {
if (LauncherAppState.isDisableAllApps()) {
final ArrayList<ItemInfo> addedInfos=new ArrayList<ItemInfo>(added);
addAndBindAddedWorkspaceApps(context,addedInfos);
}
 else {
addAppsToAllApps(context,added);
}
}
if (modified != null) {
final ArrayList<AppInfo> modifiedFinal=modified;
for (AppInfo a : modifiedFinal) {
ArrayList<ItemInfo> infos=getItemInfoForComponentName(a.componentName,mUser);
for (ItemInfo i : infos) {
if (i instanceof ShortcutInfo && isShortcutAppTarget((ShortcutInfo)i)) {
ShortcutInfo info=(ShortcutInfo)i;
info.title=a.title.toString();
info.contentDescription=a.contentDescription;
updateItemInDatabase(context,info);
}
}
}
mHandler.post(new Runnable(){
public void run(){
Callbacks cb=mCallbacks != null ? mCallbacks.get() : null;
if (callbacks == cb && cb != null) {
callbacks.bindAppsUpdated(modifiedFinal);
}
}
}
);
}
if (mOp == OP_ADD || mOp == OP_UPDATE) {
final ArrayList<ShortcutInfo> iconsChanged=new ArrayList<ShortcutInfo>();
HashSet<String> packageSet=new HashSet<String>(Arrays.asList(packages));
synchronized (sBgLock) {
for (ItemInfo info : sBgWorkspaceItems) {
if (info instanceof ShortcutInfo && mUser.equals(info.user)) {
ShortcutInfo si=(ShortcutInfo)info;
if ((si.iconResource != null) && packageSet.contains(si.getTargetComponent().getPackageName())) {
Bitmap icon=Utilities.createIconBitmap(si.iconResource.packageName,si.iconResource.resourceName,mIconCache,context);
if (icon != null) {
si.setIcon(icon);
si.usingFallbackIcon=false;
iconsChanged.add(si);
updateItemInDatabase(context,si);
}
}
}
}
}
if (!iconsChanged.isEmpty()) {
mHandler.post(new Runnable(){
public void run(){
Callbacks cb=mCallbacks != null ? mCallbacks.get() : null;
if (callbacks == cb && cb != null) {
callbacks.bindShortcutsUpdated(iconsChanged);
}
}
}
);
}
}
final ArrayList<String> removedPackageNames=new ArrayList<String>();
if (mOp == OP_REMOVE || mOp == OP_UNAVAILABLE) {
removedPackageNames.addAll(Arrays.asList(packages));
}
 else if (mOp == OP_UPDATE) {
for (int i=0; i < N; i++) {
if (isPackageDisabled(context,packages[i],mUser)) {
removedPackageNames.add(packages[i]);
}
}
}
if (!removedPackageNames.isEmpty() || !removedApps.isEmpty()) {
final int removeReason;
if (mOp == OP_UNAVAILABLE) {
removeReason=ShortcutInfo.FLAG_DISABLED_NOT_AVAILABLE;
}
 else {
for (String pn : removedPackageNames) {
deletePackageFromDatabase(context,pn,mUser);
}
for (AppInfo a : removedApps) {
ArrayList<ItemInfo> infos=getItemInfoForComponentName(a.componentName,mUser);
deleteItemsFromDatabase(context,infos);
}
removeReason=0;
}
String spKey=LauncherAppState.getSharedPreferencesKey();
SharedPreferences sp=context.getSharedPreferences(spKey,Context.MODE_PRIVATE);
InstallShortcutReceiver.removeFromInstallQueue(sp,removedPackageNames);
mHandler.post(new Runnable(){
public void run(){
Callbacks cb=mCallbacks != null ? mCallbacks.get() : null;
if (callbacks == cb && cb != null) {
callbacks.bindComponentsRemoved(removedPackageNames,removedApps,mUser,removeReason);
}
}
}
);
}
final ArrayList<Object> widgetsAndShortcuts=getSortedWidgetsAndShortcuts(context);
mHandler.post(new Runnable(){
@Override public void run(){
Callbacks cb=mCallbacks != null ? mCallbacks.get() : null;
if (callbacks == cb && cb != null) {
callbacks.bindPackagesUpdated(widgetsAndShortcuts);
}
}
}
);
mHandler.post(new Runnable(){
public void run(){
Callbacks cb=mCallbacks != null ? mCallbacks.get() : null;
if (callbacks == cb && cb != null) {
callbacks.dumpLogsToLocalData();
}
}
}
);
}
