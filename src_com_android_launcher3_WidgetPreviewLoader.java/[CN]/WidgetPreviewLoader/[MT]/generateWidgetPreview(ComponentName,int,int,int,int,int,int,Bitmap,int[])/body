{
  String packageName=provider.getPackageName();
  if (maxPreviewWidth < 0)   maxPreviewWidth=Integer.MAX_VALUE;
  if (maxPreviewHeight < 0)   maxPreviewHeight=Integer.MAX_VALUE;
  Drawable drawable=null;
  if (previewImage != 0) {
    drawable=mutateOnMainThread(mPackageManager.getDrawable(packageName,previewImage,null));
    if (drawable == null) {
      Log.w(TAG,"Can't load widget preview drawable 0x" + Integer.toHexString(previewImage) + " for provider: "+ provider);
    }
  }
  int previewWidth;
  int previewHeight;
  Bitmap defaultPreview=null;
  boolean widgetPreviewExists=(drawable != null);
  if (widgetPreviewExists) {
    previewWidth=drawable.getIntrinsicWidth();
    previewHeight=drawable.getIntrinsicHeight();
  }
 else {
    if (cellHSpan < 1)     cellHSpan=1;
    if (cellVSpan < 1)     cellVSpan=1;
    BitmapDrawable previewDrawable=(BitmapDrawable)mContext.getResources().getDrawable(R.drawable.widget_tile);
    final int previewDrawableWidth=previewDrawable.getIntrinsicWidth();
    final int previewDrawableHeight=previewDrawable.getIntrinsicHeight();
    previewWidth=previewDrawableWidth * cellHSpan;
    previewHeight=previewDrawableHeight * cellVSpan;
    defaultPreview=Bitmap.createBitmap(previewWidth,previewHeight,Config.ARGB_8888);
    final Canvas c=mCachedAppWidgetPreviewCanvas.get();
    c.setBitmap(defaultPreview);
    Paint p=mDefaultAppWidgetPreviewPaint.get();
    if (p == null) {
      p=new Paint();
      p.setShader(new BitmapShader(previewDrawable.getBitmap(),Shader.TileMode.REPEAT,Shader.TileMode.REPEAT));
      mDefaultAppWidgetPreviewPaint.set(p);
    }
    final Rect dest=mCachedAppWidgetPreviewDestRect.get();
    dest.set(0,0,previewWidth,previewHeight);
    c.drawRect(dest,p);
    c.setBitmap(null);
    int minOffset=(int)(mAppIconSize * sWidgetPreviewIconPaddingPercentage);
    int smallestSide=Math.min(previewWidth,previewHeight);
    float iconScale=Math.min((float)smallestSide / (mAppIconSize + 2 * minOffset),1f);
    try {
      Drawable icon=null;
      int hoffset=(int)((previewDrawableWidth - mAppIconSize * iconScale) / 2);
      int yoffset=(int)((previewDrawableHeight - mAppIconSize * iconScale) / 2);
      if (iconId > 0)       icon=mutateOnMainThread(mIconCache.getFullResIcon(packageName,iconId));
      if (icon != null) {
        renderDrawableToBitmap(icon,defaultPreview,hoffset,yoffset,(int)(mAppIconSize * iconScale),(int)(mAppIconSize * iconScale));
      }
    }
 catch (    Resources.NotFoundException e) {
    }
  }
  float scale=1f;
  if (preScaledWidthOut != null) {
    preScaledWidthOut[0]=previewWidth;
  }
  if (previewWidth > maxPreviewWidth) {
    scale=maxPreviewWidth / (float)previewWidth;
  }
  if (scale != 1f) {
    previewWidth=(int)(scale * previewWidth);
    previewHeight=(int)(scale * previewHeight);
  }
  if (preview == null) {
    preview=Bitmap.createBitmap(previewWidth,previewHeight,Config.ARGB_8888);
  }
  int x=(preview.getWidth() - previewWidth) / 2;
  if (widgetPreviewExists) {
    renderDrawableToBitmap(drawable,preview,x,0,previewWidth,previewHeight);
  }
 else {
    final Canvas c=mCachedAppWidgetPreviewCanvas.get();
    final Rect src=mCachedAppWidgetPreviewSrcRect.get();
    final Rect dest=mCachedAppWidgetPreviewDestRect.get();
    c.setBitmap(preview);
    src.set(0,0,defaultPreview.getWidth(),defaultPreview.getHeight());
    dest.set(x,0,x + previewWidth,previewHeight);
    Paint p=mCachedAppWidgetPreviewPaint.get();
    if (p == null) {
      p=new Paint();
      p.setFilterBitmap(true);
      mCachedAppWidgetPreviewPaint.set(p);
    }
    c.drawBitmap(defaultPreview,src,dest,p);
    c.setBitmap(null);
  }
  return preview;
}
