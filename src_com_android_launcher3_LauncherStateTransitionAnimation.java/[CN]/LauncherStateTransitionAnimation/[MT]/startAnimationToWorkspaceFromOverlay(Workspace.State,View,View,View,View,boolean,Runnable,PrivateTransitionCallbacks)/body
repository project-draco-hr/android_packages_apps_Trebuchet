{
  final Resources res=mLauncher.getResources();
  final boolean material=Utilities.isLmpOrAbove();
  final int revealDuration=res.getInteger(R.integer.config_appsCustomizeRevealTime);
  final int itemsAlphaStagger=res.getInteger(R.integer.config_appsCustomizeItemsAlphaStagger);
  final View allAppsButtonView=mLauncher.getAllAppsButton();
  final View toView=mLauncher.getWorkspace();
  final HashMap<View,Integer> layerViews=new HashMap<>();
  boolean initialized=allAppsButtonView != null;
  cancelAnimation();
  Animator workspaceAnim=mLauncher.getWorkspace().getChangeStateAnimation(toWorkspaceState,animated,layerViews);
  if (animated && initialized) {
    mStateAnimation=LauncherAnimUtils.createAnimatorSet();
    if (workspaceAnim != null) {
      mStateAnimation.play(workspaceAnim);
    }
    if (fromView.getVisibility() == View.VISIBLE) {
      int width=revealView.getMeasuredWidth();
      int height=revealView.getMeasuredHeight();
      float revealRadius=(float)Math.sqrt((width * width) / 4 + (height * height) / 4);
      revealView.setVisibility(View.VISIBLE);
      revealView.setAlpha(1f);
      revealView.setTranslationY(0);
      layerViews.put(revealView,BUILD_AND_SET_LAYER);
      pCb.onRevealViewVisible(revealView,contentView,allAppsButtonView);
      final float revealViewToXDrift;
      final float revealViewToYDrift;
      if (material) {
        revealViewToYDrift=pCb.getMaterialRevealViewFinalYDrift(revealView);
        revealViewToXDrift=pCb.getMaterialRevealViewFinalXDrift(revealView);
      }
 else {
        revealViewToYDrift=2 * height / 3;
        revealViewToXDrift=0;
      }
      TimeInterpolator decelerateInterpolator=material ? new LogDecelerateInterpolator(100,0) : new DecelerateInterpolator(1f);
      ObjectAnimator panelDriftY=LauncherAnimUtils.ofFloat(revealView,"translationY",0,revealViewToYDrift);
      panelDriftY.setDuration(revealDuration - SINGLE_FRAME_DELAY);
      panelDriftY.setStartDelay(itemsAlphaStagger + SINGLE_FRAME_DELAY);
      panelDriftY.setInterpolator(decelerateInterpolator);
      mStateAnimation.play(panelDriftY);
      ObjectAnimator panelDriftX=LauncherAnimUtils.ofFloat(revealView,"translationX",0,revealViewToXDrift);
      panelDriftX.setDuration(revealDuration - SINGLE_FRAME_DELAY);
      panelDriftX.setStartDelay(itemsAlphaStagger + SINGLE_FRAME_DELAY);
      panelDriftX.setInterpolator(decelerateInterpolator);
      mStateAnimation.play(panelDriftX);
      final float revealViewToAlpha=!material ? 0f : pCb.getMaterialRevealViewFinalAlpha(revealView);
      if (revealViewToAlpha != 1f) {
        ObjectAnimator panelAlpha=LauncherAnimUtils.ofFloat(revealView,"alpha",1f,revealViewToAlpha);
        panelAlpha.setDuration(material ? revealDuration : 150);
        panelAlpha.setStartDelay(material ? 0 : itemsAlphaStagger + SINGLE_FRAME_DELAY);
        panelAlpha.setInterpolator(decelerateInterpolator);
        mStateAnimation.play(panelAlpha);
      }
      layerViews.put(contentView,BUILD_AND_SET_LAYER);
      ObjectAnimator pageDrift=LauncherAnimUtils.ofFloat(contentView,"translationY",0,revealViewToYDrift);
      contentView.setTranslationY(0);
      pageDrift.setDuration(revealDuration - SINGLE_FRAME_DELAY);
      pageDrift.setInterpolator(decelerateInterpolator);
      pageDrift.setStartDelay(itemsAlphaStagger + SINGLE_FRAME_DELAY);
      mStateAnimation.play(pageDrift);
      contentView.setAlpha(1f);
      ObjectAnimator itemsAlpha=LauncherAnimUtils.ofFloat(contentView,"alpha",1f,0f);
      itemsAlpha.setDuration(100);
      itemsAlpha.setInterpolator(decelerateInterpolator);
      mStateAnimation.play(itemsAlpha);
      if (pageIndicatorsView != null) {
        pageIndicatorsView.setAlpha(1f);
        ObjectAnimator indicatorsAlpha=LauncherAnimUtils.ofFloat(pageIndicatorsView,"alpha",0f);
        indicatorsAlpha.setDuration(revealDuration);
        indicatorsAlpha.setInterpolator(new DecelerateInterpolator(1.5f));
        mStateAnimation.play(indicatorsAlpha);
      }
      if (material) {
        float finalRadius=pCb.getMaterialRevealViewStartFinalRadius();
        AnimatorListenerAdapter listener=pCb.getMaterialRevealViewAnimatorListener(revealView,allAppsButtonView);
        Animator reveal=LauncherAnimUtils.createCircularReveal(revealView,width / 2,height / 2,revealRadius,finalRadius);
        reveal.setInterpolator(new LogDecelerateInterpolator(100,0));
        reveal.setDuration(revealDuration);
        reveal.setStartDelay(itemsAlphaStagger);
        if (listener != null) {
          reveal.addListener(listener);
        }
        mStateAnimation.play(reveal);
      }
      dispatchOnLauncherTransitionPrepare(fromView,animated,true);
      dispatchOnLauncherTransitionPrepare(toView,animated,true);
    }
    mStateAnimation.addListener(new AnimatorListenerAdapter(){
      @Override public void onAnimationEnd(      Animator animation){
        fromView.setVisibility(View.GONE);
        dispatchOnLauncherTransitionEnd(fromView,animated,true);
        dispatchOnLauncherTransitionEnd(toView,animated,true);
        if (onCompleteRunnable != null) {
          onCompleteRunnable.run();
        }
        pCb.onAnimationComplete(revealView,contentView,allAppsButtonView);
        for (        View v : layerViews.keySet()) {
          if (layerViews.get(v) == BUILD_AND_SET_LAYER) {
            v.setLayerType(View.LAYER_TYPE_NONE,null);
          }
        }
        if (contentView != null) {
          contentView.setTranslationX(0);
          contentView.setTranslationY(0);
          contentView.setAlpha(1);
        }
        mStateAnimation=null;
      }
    }
);
    final AnimatorSet stateAnimation=mStateAnimation;
    final Runnable startAnimRunnable=new Runnable(){
      public void run(){
        if (mStateAnimation != stateAnimation)         return;
        dispatchOnLauncherTransitionStart(fromView,animated,false);
        dispatchOnLauncherTransitionStart(toView,animated,false);
        for (        View v : layerViews.keySet()) {
          if (layerViews.get(v) == BUILD_AND_SET_LAYER) {
            v.setLayerType(View.LAYER_TYPE_HARDWARE,null);
          }
          if (Utilities.isLmpOrAbove()) {
            v.buildLayer();
          }
        }
        mStateAnimation.start();
      }
    }
;
    fromView.post(startAnimRunnable);
  }
 else {
    fromView.setVisibility(View.GONE);
    dispatchOnLauncherTransitionPrepare(fromView,animated,true);
    dispatchOnLauncherTransitionStart(fromView,animated,true);
    dispatchOnLauncherTransitionEnd(fromView,animated,true);
    dispatchOnLauncherTransitionPrepare(toView,animated,true);
    dispatchOnLauncherTransitionStart(toView,animated,true);
    dispatchOnLauncherTransitionEnd(toView,animated,true);
    if (onCompleteRunnable != null) {
      onCompleteRunnable.run();
    }
  }
}
