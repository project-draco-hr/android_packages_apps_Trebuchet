{
  if (sIconWidth == -1) {
    final Resources resources=context.getResources();
    sIconWidth=sIconHeight=(int)resources.getDimension(android.R.dimen.app_icon_size);
  }
  int width=sIconWidth;
  int height=sIconHeight;
  float scale=1.0f;
  if (icon instanceof PaintDrawable) {
    PaintDrawable painter=(PaintDrawable)icon;
    painter.setIntrinsicWidth(width);
    painter.setIntrinsicHeight(height);
  }
 else   if (icon instanceof BitmapDrawable) {
    float displayDensity=context.getResources().getDisplayMetrics().density;
    BitmapDrawable bitmapDrawable=(BitmapDrawable)icon;
    Bitmap bitmap=bitmapDrawable.getBitmap();
    float iconDensity=bitmap.getDensityScale();
    scale=displayDensity / iconDensity;
    if (scale != 1.0f) {
      icon=bitmapDrawable=new BitmapDrawable(bitmap);
      bitmapDrawable.setDensityScale(scale);
    }
  }
  int iconWidth=icon.getIntrinsicWidth();
  int iconHeight=icon.getIntrinsicHeight();
  if (width > 0 && height > 0) {
    if (width < iconWidth || height < iconHeight || scale != 1.0f) {
      final float ratio=(float)iconWidth / iconHeight;
      if (iconWidth > iconHeight) {
        height=(int)(width / ratio);
      }
 else       if (iconHeight > iconWidth) {
        width=(int)(height * ratio);
      }
      final Bitmap.Config c=icon.getOpacity() != PixelFormat.OPAQUE ? Bitmap.Config.ARGB_8888 : Bitmap.Config.RGB_565;
      final Bitmap thumb=Bitmap.createBitmap(sIconWidth,sIconHeight,c);
      final Canvas canvas=sCanvas;
      canvas.setBitmap(thumb);
      sOldBounds.set(icon.getBounds());
      final int x=(sIconWidth - width) / 2;
      final int y=(sIconHeight - height) / 2;
      icon.setBounds(x,y,x + width,y + height);
      icon.draw(canvas);
      icon.setBounds(sOldBounds);
      icon=new FastBitmapDrawable(thumb);
    }
 else     if (iconWidth < width && iconHeight < height) {
      final Bitmap.Config c=Bitmap.Config.ARGB_8888;
      final Bitmap thumb=Bitmap.createBitmap(sIconWidth,sIconHeight,c);
      final Canvas canvas=sCanvas;
      canvas.setBitmap(thumb);
      sOldBounds.set(icon.getBounds());
      final int x=(width - iconWidth) / 2;
      final int y=(height - iconHeight) / 2;
      icon.setBounds(x,y,x + iconWidth,y + iconHeight);
      icon.draw(canvas);
      icon.setBounds(sOldBounds);
      icon=new FastBitmapDrawable(thumb);
    }
  }
  return icon;
}
