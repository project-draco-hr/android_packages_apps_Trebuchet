{
  int widthSpecMode=MeasureSpec.getMode(widthMeasureSpec);
  int widthSpecSize=MeasureSpec.getSize(widthMeasureSpec);
  int heightSpecMode=MeasureSpec.getMode(heightMeasureSpec);
  int heightSpecSize=MeasureSpec.getSize(heightMeasureSpec);
  if (widthSpecMode == MeasureSpec.UNSPECIFIED || heightSpecMode == MeasureSpec.UNSPECIFIED) {
    throw new RuntimeException("CellLayout cannot have UNSPECIFIED dimensions");
  }
  int numWidthGaps=mCellCountX - 1;
  int numHeightGaps=mCellCountY - 1;
  if (mOriginalWidthGap < 0 || mOriginalHeightGap < 0) {
    int hSpace=widthSpecSize - getPaddingLeft() - getPaddingRight();
    int vSpace=heightSpecSize - getPaddingTop() - getPaddingBottom();
    int hFreeSpace=hSpace - (mCellCountX * mOriginalCellWidth);
    int vFreeSpace=vSpace - (mCellCountY * mOriginalCellHeight);
    mWidthGap=Math.min(mMaxGap,numWidthGaps > 0 ? (hFreeSpace / numWidthGaps) : 0);
    mHeightGap=Math.min(mMaxGap,numHeightGaps > 0 ? (vFreeSpace / numHeightGaps) : 0);
    mChildren.setGap(mWidthGap,mHeightGap);
  }
 else {
    mWidthGap=mOriginalWidthGap;
    mHeightGap=mOriginalHeightGap;
  }
  int newWidth=widthSpecSize;
  int newHeight=heightSpecSize;
  if (widthSpecMode == MeasureSpec.AT_MOST) {
    newWidth=getPaddingLeft() + getPaddingRight() + (mCellCountX * mCellWidth)+ ((mCellCountX - 1) * mWidthGap);
    newHeight=getPaddingTop() + getPaddingBottom() + (mCellCountY * mCellHeight)+ ((mCellCountY - 1) * mHeightGap);
    setMeasuredDimension(newWidth,newHeight);
  }
  final int count=getChildCount();
  for (int i=0; i < count; i++) {
    View child=getChildAt(i);
    int childWidthMeasureSpec=MeasureSpec.makeMeasureSpec(newWidth - getPaddingLeft() - getPaddingRight(),MeasureSpec.EXACTLY);
    int childheightMeasureSpec=MeasureSpec.makeMeasureSpec(newHeight - getPaddingTop() - getPaddingBottom(),MeasureSpec.EXACTLY);
    child.measure(childWidthMeasureSpec,childheightMeasureSpec);
  }
  setMeasuredDimension(newWidth,newHeight);
}
