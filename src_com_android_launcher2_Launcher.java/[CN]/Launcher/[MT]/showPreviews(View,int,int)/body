{
  Drawable d=getResources().getDrawable(R.drawable.preview_popup);
  Workspace workspace=mWorkspace;
  CellLayout cell=((CellLayout)workspace.getChildAt(start));
  float max=workspace.getChildCount() - 1;
  Rect r=new Rect();
  d.getPadding(r);
  int extraW=(int)((r.left + r.right) * max);
  int extraH=r.top + r.bottom;
  int aW=cell.getWidth() - extraW;
  float w=aW / max;
  int width=cell.getWidth();
  int height=cell.getHeight();
  int x=cell.getLeftPadding();
  int y=cell.getTopPadding();
  width-=(x + cell.getRightPadding());
  height-=(y + cell.getBottomPadding());
  float scale=w / width;
  int count=end - start;
  final float sWidth=width * scale;
  float sHeight=height * scale;
  LinearLayout preview=new LinearLayout(this);
  preview.setFocusable(true);
  PreviewTouchHandler handler=new PreviewTouchHandler(anchor);
  ArrayList<Bitmap> bitmaps=new ArrayList<Bitmap>(count);
  for (int i=start; i < end; i++) {
    ImageView image=new ImageView(this);
    cell=(CellLayout)workspace.getChildAt(i);
    Bitmap bitmap=Bitmap.createBitmap((int)sWidth,(int)sHeight,Bitmap.Config.ARGB_8888);
    Canvas c=new Canvas(bitmap);
    c.scale(scale,scale);
    c.translate(-cell.getLeftPadding(),-cell.getTopPadding());
    cell.dispatchDraw(c);
    image.setBackgroundDrawable(d);
    image.setImageBitmap(bitmap);
    image.setTag(i);
    image.setOnClickListener(handler);
    bitmaps.add(bitmap);
    preview.addView(image,ViewGroup.LayoutParams.WRAP_CONTENT,ViewGroup.LayoutParams.WRAP_CONTENT);
  }
  PopupWindow p=new PopupWindow(this);
  p.setContentView(preview);
  p.setWidth((int)(sWidth * count + extraW));
  p.setHeight((int)(sHeight + extraH));
  p.setAnimationStyle(R.style.AnimationPreview);
  p.setOutsideTouchable(true);
  p.setBackgroundDrawable(null);
  p.showAsDropDown(anchor,0,0);
  p.setOnDismissListener(new PopupWindow.OnDismissListener(){
    public void onDismiss(){
      dismissPreview(anchor);
    }
  }
);
  anchor.setTag(p);
  anchor.setTag(R.id.workspace,preview);
  anchor.setTag(R.id.icon,bitmaps);
}
