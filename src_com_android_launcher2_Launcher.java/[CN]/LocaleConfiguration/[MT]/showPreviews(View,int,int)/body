{
  final Resources resources=getResources();
  final Workspace workspace=mWorkspace;
  CellLayout cell=((CellLayout)workspace.getChildAt(start));
  float max=workspace.getChildCount();
  final Rect r=new Rect();
  resources.getDrawable(R.drawable.preview_background).getPadding(r);
  int extraW=(int)((r.left + r.right) * max);
  int extraH=r.top + r.bottom;
  int aW=cell.getWidth() - extraW;
  float w=aW / max;
  int width=cell.getWidth();
  int height=cell.getHeight();
  int x=cell.getPaddingLeft();
  int y=cell.getPaddingTop();
  width-=(x + cell.getPaddingRight());
  height-=(y + cell.getPaddingBottom());
  float scale=w / width;
  int count=end - start;
  final float sWidth=width * scale;
  float sHeight=height * scale;
  LinearLayout preview=new LinearLayout(this);
  PreviewTouchHandler handler=new PreviewTouchHandler(anchor);
  ArrayList<Bitmap> bitmaps=new ArrayList<Bitmap>(count);
  for (int i=start; i < end; i++) {
    ImageView image=new ImageView(this);
    cell=(CellLayout)workspace.getChildAt(i);
    final Bitmap bitmap=Bitmap.createBitmap((int)sWidth,(int)sHeight,Bitmap.Config.ARGB_8888);
    final Canvas c=new Canvas(bitmap);
    c.scale(scale,scale);
    c.translate(-cell.getPaddingLeft(),-cell.getPaddingTop());
    cell.drawChildren(c);
    image.setBackgroundDrawable(resources.getDrawable(R.drawable.preview_background));
    image.setImageBitmap(bitmap);
    image.setTag(i);
    image.setOnClickListener(handler);
    image.setOnFocusChangeListener(handler);
    image.setFocusable(true);
    if (i == mWorkspace.getCurrentPage())     image.requestFocus();
    preview.addView(image,LinearLayout.LayoutParams.WRAP_CONTENT,LinearLayout.LayoutParams.WRAP_CONTENT);
    bitmaps.add(bitmap);
  }
  final PopupWindow p=new PopupWindow(this);
  p.setContentView(preview);
  p.setWidth((int)(sWidth * count + extraW));
  p.setHeight((int)(sHeight + extraH));
  p.setAnimationStyle(R.style.AnimationPreview);
  p.setOutsideTouchable(true);
  p.setFocusable(true);
  p.setBackgroundDrawable(new ColorDrawable(0));
  p.showAsDropDown(anchor,0,0);
  p.setOnDismissListener(new PopupWindow.OnDismissListener(){
    public void onDismiss(){
      dismissPreview(anchor);
    }
  }
);
  anchor.setTag(p);
  anchor.setTag(R.id.workspace,preview);
  anchor.setTag(R.id.all_apps_button_cluster,bitmaps);
}
